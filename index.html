<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnlimitedCommunity</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Variables for theme customization */
        :root {
            --theme-color: #28a745; /* Default theme color */
            --primary-bg: #f9f9f9;
            --card-bg: #fff;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #eee;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        /* Basic Reset & Typography */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--primary-bg);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Main Container */
        .container {
            max-width: 960px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 4px 20px var(--shadow-color);
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--card-bg);
        }

        /* Header */
        header {
            background-color: var(--theme-color);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        .title {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Announcement */
        .announcement {
            background-color: #ffc107; /* A soft yellow for announcement */
            color: #856404;
            padding: 15px 20px;
            margin: -20px 20px 20px; /* Overlap with header slightly */
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background-color: var(--card-bg);
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--light-text-color);
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab:hover {
            background-color: var(--primary-bg);
        }
        .tab.active {
            background-color: var(--theme-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Content Area */
        .content {
            padding: 20px;
            min-height: 450px;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px var(--shadow-color);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .card-title {
            font-size: 1.4rem;
            color: var(--theme-color);
            margin: 0;
        }
        .card-meta {
            font-size: 0.85rem;
            color: var(--light-text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-meta i {
            margin-right: 3px;
        }
        .card-body p {
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--text-color);
        }
        .card-actions {
            text-align: right;
            margin-top: 15px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            border: none;
            outline: none;
        }
        .btn-primary {
            background-color: var(--theme-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: darken(var(--theme-color), 10%); /* Custom darken function not available in pure CSS */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--light-text-color);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        /* Asset List (for Releases) */
        .assets-list {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }
        .assets-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
            font-size: 0.9rem;
        }
        .assets-list li:last-child {
            border-bottom: none;
        }
        .asset-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--light-text-color);
        }
        .asset-info a {
            color: var(--theme-color);
            text-decoration: none;
        }
        .asset-info a:hover {
            text-decoration: underline;
        }
        .asset-info i {
            color: #999;
        }

        /* Discussion specific styles */
        .issue-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .issue-label {
            background-color: #e0e0e0;
            color: #666;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .comment-section {
            background-color: var(--primary-bg);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px; /* Limit height for comments */
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .comment-item {
            border-bottom: 1px dotted #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .comment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .comment-header {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--light-text-color);
            margin-bottom: 5px;
        }
        .comment-header img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .comment-header strong {
            color: var(--text-color);
        }
        .comment-body {
            font-size: 0.9rem;
            color: var(--text-color);
            word-wrap: break-word; /* Ensure long words break */
        }
        .comment-body pre {
            background-color: #eee;
            padding: 5px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        /* Create Discussion Form */
        #create-discussion-form {
            padding: 20px;
        }
        #create-discussion-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        #create-discussion-form input[type="text"],
        #create-discussion-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        #create-discussion-form input[type="text"]:focus,
        #create-discussion-form textarea:focus {
            border-color: var(--theme-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--theme-color-rgb, 40, 167, 69), 0.2);
        }
        #create-discussion-form textarea {
            min-height: 120px;
            resize: vertical;
        }
        #create-discussion-form button {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
        }
        .form-feedback {
            font-size: 0.85rem;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        .form-feedback.error {
            color: var(--error-color);
        }

        /* Notifications */
        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .notification {
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.success {
            border-left: 5px solid var(--success-color);
        }
        .notification.error {
            border-left: 5px solid var(--error-color);
        }
        .notification i {
            font-size: 1.2rem;
        }
        .notification.success i {
            color: var(--success-color);
        }
        .notification.error i {
            color: var(--error-color);
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--light-text-color);
        }
        .loading i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--light-text-color);
            font-style: italic;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                border-radius: 0;
            }
            header {
                padding: 30px 15px;
                border-radius: 0;
            }
            .title {
                font-size: 2rem;
            }
            .subtitle {
                font-size: 1rem;
            }
            .announcement {
                margin: -15px 15px 15px;
                padding: 12px 15px;
            }
            .tabs {
                flex-wrap: wrap;
                justify-content: space-around;
            }
            .tab {
                padding: 10px 15px;
                font-size: 1rem;
                margin: 5px;
            }
            .content {
                padding: 15px;
            }
            .card {
                padding: 15px;
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .card-meta {
                margin-top: 8px;
            }
            .notification {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title" id="site-title"><i class="fas fa-spinner fa-spin"></i> Loading...</h1>
            <div class="subtitle" id="site-subtitle"></div>
        </header>
        
        <div class="announcement" id="site-announcement"></div>
        
        <div class="tabs">
            <div class="tab active" data-tab="releases"><i class="fas fa-download"></i> Resources</div>
            <div class="tab" data-tab="discussions"><i class="fas fa-comments"></i> Discussions</div>
            <div class="tab" data-tab="create-discussion"><i class="fas fa-plus-circle"></i> Create Discussion</div>
        </div>
        
        <div class="content" id="content">
            <!-- Content will be loaded here -->
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading content...</div>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notifications"></div>

    <script>
        let config = {};
        const contentContainer = document.getElementById('content');
        const notificationsContainer = document.getElementById('notifications');
        const githubApiBaseUrl = 'https://api.github.com';
        let repoPath = '';

        // --- Utility Functions ---
        function escapeHtml(unsafe) {
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function generateProxyUrl(url) {
            return `https://ghproxy.net/${encodeURI(url)}`;
        }

        function formatFileSize(bytes) {
            const units = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Bytes';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + units[i];
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleString('zh-CN', options);
        }

        function showNotification(message, type) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification ${type}`;
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            notificationDiv.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            
            notificationsContainer.appendChild(notificationDiv);
            setTimeout(() => {
                notificationDiv.classList.add('show');
            }, 10); // Small delay to trigger CSS transition

            setTimeout(() => {
                notificationDiv.classList.remove('show');
                notificationDiv.addEventListener('transitionend', () => notificationDiv.remove());
            }, 3000); // Notification disappears after 3 seconds
        }

        function showLoading(message = '正在加载...') {
            contentContainer.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> ${message}</div>`;
        }

        function showEmptyState(message = '暂无内容') {
            contentContainer.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i> ${message}</div>`;
        }

        // --- Core Functions ---

        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                config = await response.json();
                
                document.getElementById('site-title').innerHTML = `<i class="fas fa-users"></i> ${escapeHtml(config.title)}`;
                document.getElementById('site-subtitle').textContent = escapeHtml(config.subtitle);
                document.getElementById('site-announcement').textContent = escapeHtml(config.announcement);
                document.documentElement.style.setProperty('--theme-color', config.theme_color);
                
                // Set RGB values for box-shadow in focus state
                const hex = config.theme_color.startsWith('#') ? config.theme_color.slice(1) : config.theme_color;
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                document.documentElement.style.setProperty('--theme-color-rgb', `${r}, ${g}, ${b}`);

                repoPath = config.github_repo;
                if (!repoPath) {
                    showErrorNotification('请在 config.json 中设置 github_repo！');
                    return;
                }
                loadReleases(); // Load releases by default
            } catch (error) {
                console.error('Error loading config:', error);
                showErrorNotification(`配置加载失败: ${error.message}`);
                document.getElementById('site-title').textContent = 'Error';
                document.getElementById('site-subtitle').textContent = 'Failed to load configuration.';
            }
        }

        async function loadReleases() {
            showLoading('正在加载资源...');
            try {
                const response = await fetch(`${githubApiBaseUrl}/repos/${repoPath}/releases`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const releases = await response.json();

                if (releases.length === 0) {
                    showEmptyState('暂无可用资源。');
                    return;
                }

                contentContainer.innerHTML = releases.map(release => `
                    <div class="card release-item">
                        <div class="card-header">
                            <h3 class="card-title">${escapeHtml(release.name || release.tag_name)}</h3>
                            <div class="card-meta">
                                <i class="fas fa-calendar-alt"></i> ${formatDate(release.published_at)}
                                <i class="fas fa-user"></i> ${escapeHtml(release.author.login)}
                            </div>
                        </div>
                        <div class="card-body">
                            <p>${escapeHtml(release.body || '无描述')}</p>
                            ${release.assets.length > 0 ? `
                                <button class="btn btn-secondary toggle-assets-btn" data-toggle-id="assets-${release.id}">
                                    <i class="fas fa-layer-group"></i> 显示资源 (${release.assets.length})
                                </button>
                                <ul class="assets-list" id="assets-${release.id}" style="display: none;">
                                    ${release.assets.map(asset => `
                                        <li>
                                            <div class="asset-info">
                                                <i class="fas fa-file"></i>
                                                <a href="${generateProxyUrl(asset.browser_download_url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(asset.name)}</a>
                                            </div>
                                            <span>${formatFileSize(asset.size)}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : '<p class="empty-state" style="padding: 0;">无附件。</p>'}
                        </div>
                    </div>
                `).join('');

                // Add event listeners for toggle buttons
                document.querySelectorAll('.toggle-assets-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const targetId = this.dataset.toggleId;
                        const assetsList = document.getElementById(targetId);
                        if (assetsList.style.display === 'none') {
                            assetsList.style.display = 'block';
                            this.innerHTML = '<i class="fas fa-layer-group"></i> 隐藏资源';
                        } else {
                            assetsList.style.display = 'none';
                            this.innerHTML = `<i class="fas fa-layer-group"></i> 显示资源 (${assetsList.children.length})`;
                        }
                    });
                });

            } catch (error) {
                console.error('Error loading releases:', error);
                showErrorNotification(`资源加载失败: ${error.message}`);
                contentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i> 资源加载失败，请检查网络或配置。</div>';
            }
        }

        async function fetchDiscussions() {
            showLoading('正在加载讨论...');
            try {
                const response = await fetch(`${githubApiBaseUrl}/repos/${repoPath}/issues?state=open&per_page=20`); // Only open issues for discussion
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const issues = await response.json();

                if (issues.length === 0) {
                    showEmptyState('暂无讨论，快来创建一个吧！');
                    return;
                }

                contentContainer.innerHTML = issues.map(issue => `
                    <div class="card discussion-item">
                        <div class="card-header">
                            <h3 class="card-title">
                                <a href="https://github.com/${repoPath}/issues/${issue.number}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">
                                    ${escapeHtml(issue.title)}
                                </a>
                            </h3>
                            <div class="card-meta">
                                <i class="fas fa-calendar-alt"></i> ${formatDate(issue.created_at)}
                                <i class="fas fa-user"></i> ${escapeHtml(issue.user.login)}
                            </div>
                        </div>
                        <div class="card-body">
                            <p>${escapeHtml(issue.body ? issue.body.substring(0, 150) + (issue.body.length > 150 ? '...' : '') : '无描述')}</p>
                            <div class="issue-labels">
                                ${issue.labels.map(label => `<span class="issue-label" style="background-color: #${label.color}; color: ${getContrastColor(label.color)};">${escapeHtml(label.name)}</span>`).join('')}
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-secondary toggle-comments-btn" data-issue-number="${issue.number}" data-comments-url="${issue.comments_url}">
                                    <i class="fas fa-comments"></i> 显示评论 (${issue.comments})
                                </button>
                                <a href="https://github.com/${repoPath}/issues/${issue.number}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt"></i> 查看完整讨论
                                </a>
                            </div>
                            <div class="comment-section" id="comments-${issue.number}" style="display: none;">
                                <!-- Comments will be loaded here -->
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for toggle comments
                document.querySelectorAll('.toggle-comments-btn').forEach(button => {
                    button.addEventListener('click', async function() {
                        const issueNumber = this.dataset.issueNumber;
                        const commentsUrl = this.dataset.commentsUrl;
                        const commentsContainer = document.getElementById(`comments-${issueNumber}`);
                        
                        if (commentsContainer.style.display === 'none') {
                            commentsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 加载评论中...</div>';
                            commentsContainer.style.display = 'block';
                            this.innerHTML = '<i class="fas fa-comments"></i> 隐藏评论';
                            
                            try {
                                const response = await fetch(commentsUrl);
                                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                                const comments = await response.json();

                                if (comments.length === 0) {
                                    commentsContainer.innerHTML = '<div class="empty-state" style="padding: 10px;">暂无评论。</div>';
                                } else {
                                    commentsContainer.innerHTML = comments.map(comment => `
                                        <div class="comment-item">
                                            <div class="comment-header">
                                                <img src="${comment.user.avatar_url}" alt="${escapeHtml(comment.user.login)}" />
                                                <strong>${escapeHtml(comment.user.login)}</strong> 于 ${formatDate(comment.created_at)}
                                            </div>
                                            <div class="comment-body">${parseMarkdown(comment.body)}</div>
                                        </div>
                                    `).join('');
                                }
                            } catch (error) {
                                console.error(`Error loading comments for issue ${issueNumber}:`, error);
                                commentsContainer.innerHTML = `<div class="empty-state" style="padding: 10px; color: var(--error-color);"><i class="fas fa-exclamation-triangle"></i> 评论加载失败。</div>`;
                                showErrorNotification(`评论加载失败: ${error.message}`);
                            }
                        } else {
                            commentsContainer.style.display = 'none';
                            this.innerHTML = `<i class="fas fa-comments"></i> 显示评论 (${issue.comments})`;
                        }
                    });
                });

            } catch (error) {
                console.error('Error loading discussions:', error);
                showErrorNotification(`讨论加载失败: ${error.message}`);
                contentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i> 讨论加载失败，请检查网络或配置。</div>';
            }
        }

        function createDiscussionForm() {
            contentContainer.innerHTML = `
                <div id="create-discussion-form" class="card">
                    <h2 class="card-title" style="margin-bottom: 20px;">创建新讨论</h2>
                    <p class="form-feedback">请填写以下信息，点击提交后将跳转到GitHub页面完成发布。</p>
                    <label for="issueTitle">标题 <span style="color: var(--error-color);">*</span></label>
                    <input type="text" id="issueTitle" placeholder="请填写讨论标题" required>
                    
                    <label for="issueBody">内容 (支持Markdown)</label>
                    <textarea id="issueBody" placeholder="请填写讨论内容"></textarea>
                    
                    <button class="btn btn-primary" onclick="submitNewIssue()">
                        <i class="fas fa-paper-plane"></i> 提交到 GitHub
                    </button>
                    <p style="font-size: 0.85rem; color: var(--light-text-color); margin-top: 15px;">
                        <i class="fas fa-info-circle"></i> 提交后会打开一个新的GitHub页面，您需要在那边确认并发布。
                    </p>
                </div>
            `;
        }

        function submitNewIssue() {
            const titleInput = document.getElementById('issueTitle');
            const bodyInput = document.getElementById('issueBody');
            
            if (!titleInput.value.trim()) {
                showErrorNotification('讨论标题不能为空！');
                titleInput.focus();
                titleInput.style.borderColor = var(--error-color);
                setTimeout(() => titleInput.style.borderColor = var(--border-color), 2000);
                return;
            }

            const baseUrl = `https://github.com/${repoPath}/issues/new`;
            const params = new URLSearchParams({
                title: titleInput.value.trim(),
                body: bodyInput.value.trim(),
                labels: 'user-generated' // Optional: add a label for user-generated issues
            });

            const newWindow = window.open(`${baseUrl}?${params.toString()}`, '_blank');
            
            if (newWindow) {
                titleInput.value = '';
                bodyInput.value = '';
                showNotification('讨论创建成功！请在GitHub页面完成提交', 'success');
            } else {
                showErrorNotification('无法打开新窗口，请允许弹出窗口或手动访问GitHub创建。');
            }
        }

        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            const currentTabElement = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (currentTabElement) {
                currentTabElement.classList.add('active');
            }

            if (!repoPath) {
                 contentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i> 请先配置 GitHub 仓库信息。</div>';
                 return;
            }

            switch (tabName) {
                case 'releases':
                    loadReleases();
                    break;
                case 'discussions':
                    fetchDiscussions();
                    break;
                case 'create-discussion':
                    createDiscussionForm();
                    break;
                default:
                    loadReleases(); // Default to releases
            }
        }

        // --- Helper for markdown parsing (basic) ---
        // This is a very basic markdown parser for comments. For full markdown, consider a library.
        function parseMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // Basic bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            // Basic italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            // Basic inline code
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            // Basic block code (needs to be more robust)
            html = html.replace(/```(.*?)```/gs, '<pre>$1</pre>');
            // Basic links
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            // Basic newlines
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // --- Helper for contrasting text color based on background color ---
        function getContrastColor(hexcolor) {
            if (!hexcolor) return '#333';
            // If hexcolor is like 'ffffff', convert to 'FFFFFF'
            hexcolor = hexcolor.startsWith('#') ? hexcolor.slice(1) : hexcolor;
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var y = ((r*299)+(g*587)+(b*114))/1000;
            return (y >= 128) ? '#333' : '#fff';
        }

        // --- Event Listeners ---
        document.querySelectorAll('.tabs .tab').forEach(tab => {
            tab.addEventListener('click', function() {
                switchTab(this.dataset.tab);
            });
        });

        // Initial load
        loadConfig();
    </script>
</body>
</html>
